---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

/** Deterministic tag string -> hue (0..359). */
function tagHue(tag) {
  const s = tag.trim().toLowerCase();
  let h = 0;
  for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) >>> 0;
  return h % 360;
}

const all = await getCollection("experience");

const sectionOrder = /** @type {const} */ (["work", "leadership", "project"]);
const orderIndex = new Map(sectionOrder.map((k, i) => [k, i]));

// Sort entries globally (pinned first, then title)
const sorted = [...all].sort((a, b) =>
  Number(b.data.pinned) - Number(a.data.pinned) ||
  a.data.title.localeCompare(b.data.title)
);

// Decide which section(s) each entry appears in.
// - If showIn is present: use it (can duplicate)
// - Else: place in ONE section by priority: work > leadership > project
function sectionsFor(entry) {
  const showIn = entry.data.showIn;
  if (showIn?.length) return showIn;

  const kinds = entry.data.kinds ?? ["project"];
  // pick the highest priority kind it has
  const chosen = [...kinds].sort((a, b) => orderIndex.get(a) - orderIndex.get(b))[0];
  return [chosen];
}

const buckets = {
  work: [],
  leadership: [],
  project: [],
};

for (const e of sorted) {
  for (const sec of sectionsFor(e)) {
    buckets[sec].push(e);
  }
}
---

<BaseLayout title="Experience">
  <header>
    <h1>Experience</h1>
    <p class="desc">Work, projects, and leadership.</p>
  </header>
  <hr />

  <section>
    <h2>Work</h2>
    <div class="projects">
      {buckets.work.map((e) => (
        <div class="project">
          
            <a class="item-title" href={`/experience/${e.slug}`}>
              {e.data.title}
              {(e.data.role || e.data.start || e.data.end) && (
                <span class="item-title-meta">
                  {" "}
                  路{" "}
                  {e.data.role && <span>{e.data.role}</span>}
                  {e.data.role && (e.data.start || e.data.end) && " 路 "}
                  {(e.data.start || e.data.end) && (
                    <span>
                      {e.data.start ?? ""}
                      {e.data.end ? ` - ${e.data.end}` : ""}
                    </span>
                  )}
                </span>
              )}
            </a>
          

          <div class="desc">{e.data.desc}</div>

          {e.data.tags?.length ? (
            <ul class="tags">
              {e.data.tags.map((t) => (
                <li class="tag" style={`--tag-hue:${tagHue(t)}deg`}>{t}</li>
              ))}
            </ul>
          ) : null}
        </div>
      ))}
    </div>
  </section>

  <hr>

  <section>
    <h2>Leadership</h2>
    <div class="projects">
      {buckets.leadership.map((e) => (
        <div class="project">
          <a href={`/experience/${e.slug}`}>{e.data.title}</a>
          <div class="desc">
            {e.data.role && e.data.org ? <span>{e.data.role} 路 {e.data.org} 路 </span> : null}
            {e.data.desc}
          </div>

          {e.data.tags?.length ? (
            <ul class="tags">
              {e.data.tags.map((t) => <li class="tag" style={`--tag-hue:${tagHue(t)}deg`}>{t}</li>)}
            </ul>
          ) : null}
        </div>
      ))}
    </div>
  </section>

  <hr>

  <section>
    <h2>Personal Projects</h2>
    <div class="projects">
      {buckets.project.map((e) => (
        <div class="project">
          <a href={`/experience/${e.slug}`}>{e.data.title}</a>
          <div class="desc">{e.data.desc}</div>

          {e.data.tags?.length ? (
            <ul class="tags">
              {e.data.tags.map((t) => <li class="tag" style={`--tag-hue:${tagHue(t)}deg`}>{t}</li>)}
            </ul>
          ) : null}
        </div>
      ))}
    </div>
  </section>
</BaseLayout>
